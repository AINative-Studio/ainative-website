# Railway Deployment Configuration
# https://docs.railway.app/deploy/config-as-code
#
# This configuration enables:
# - Automatic health checks with retry logic
# - Pre-deployment validation
# - Selective file watching for auto-deployments
# - Resource optimization settings

[build]
# Build command with validation and optimization
builder = "nixpacks"
buildCommand = "npm ci && npm run build"

[deploy]
# Health check configuration
healthcheckPath = "/api/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

# Start command
startCommand = "npm run start"

# Deployment region
region = "us-west1"

# Number of replicas (staging: 1, production: set via dashboard)
numReplicas = 1

[env]
# Node environment
NODE_ENV = "production"

# Build-time optimizations
NEXT_TELEMETRY_DISABLED = "1"

[check]
# Pre-deployment validation script
# This script validates environment schema, runs tests, and checks health
preDeployCommand = "node scripts/validate-environment.js staging"

[healthcheck]
# Comprehensive health check configuration
path = "/api/health"
interval = 10
timeout = 5
threshold = 3

# Deep health check (optional, for manual verification)
# Use: curl https://your-app.railway.app/api/health/deep
# This checks database, redis, and external service connectivity

[watch]
# Files to watch for auto-deployment
include = [
    "src/**/*",
    "app/**/*",
    "pages/**/*",
    "components/**/*",
    "lib/**/*",
    "public/**/*",
    "styles/**/*",
    "package.json",
    "package-lock.json",
    "next.config.js",
    "next.config.mjs",
    "tsconfig.json"
]

exclude = [
    "**/__tests__/**",
    "**/*.test.ts",
    "**/*.test.tsx",
    "**/*.spec.ts",
    "**/*.spec.tsx",
    "node_modules/**",
    ".next/**",
    ".git/**",
    "docs/**",
    "*.md",
    "README.md",
    ".github/**",
    "scripts/**",
    ".vscode/**",
    ".idea/**"
]

# Resource configuration (can be overridden via Railway dashboard)
[resources]
# Memory limit in MB (staging: 2048, production: 4096+)
memory = 2048

# CPU limit (staging: 2.0, production: 4.0+)
cpuLimit = 2.0
