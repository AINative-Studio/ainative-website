name: Post-Deployment Verification

on:
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'URL to verify'
        required: true
        default: 'https://www.ainative.studio'
        type: string
      environment:
        description: 'Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run smoke tests
        run: npm test -- __tests__/deployment/smoke-tests.test.ts
        env:
          SMOKE_TEST_URL: ${{ inputs.deployment_url }}
          NODE_ENV: production

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: coverage/
          retention-days: 30

  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [smoke-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run post-deployment verification
        id: verify
        run: |
          npx ts-node scripts/post-deployment-verify.ts -- --url ${{ inputs.deployment_url }}
        continue-on-error: true

      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-verification-report
          path: deployment-verification-report.json
          retention-days: 90

      - name: Read verification report
        id: report
        if: always()
        run: |
          if [ -f deployment-verification-report.json ]; then
            SCORE=$(jq -r '.score' deployment-verification-report.json)
            PASSED=$(jq -r '.passed' deployment-verification-report.json)
            FAILED=$(jq -r '.failed' deployment-verification-report.json)
            WARNINGS=$(jq -r '.warnings' deployment-verification-report.json)
            HEALTHY=$(jq -r '.healthy' deployment-verification-report.json)

            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
            echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment verification summary
        if: always()
        run: |
          SCORE=${{ steps.report.outputs.score }}
          HEALTHY=${{ steps.report.outputs.healthy }}

          echo "## ðŸš€ Post-Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HEALTHY" == "true" ]; then
            echo "### âœ… Deployment is HEALTHY" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment has ISSUES" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health Score:** $SCORE%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Passed: ${{ steps.report.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: ${{ steps.report.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Warnings: ${{ steps.report.outputs.warnings }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if deployment is unhealthy
        if: steps.report.outputs.healthy == 'false'
        run: |
          echo "âŒ Deployment verification failed. The deployment is unhealthy."
          exit 1

  notify-deployment-status:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [smoke-tests, post-deployment-verification]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.smoke-tests.result }}" == "success" ]] && \
             [[ "${{ needs.post-deployment-verification.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Deployment verified successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Deployment verification failed" >> $GITHUB_OUTPUT
          fi

      - name: Create status summary
        run: |
          echo "## ${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Post-Deployment Verification: ${{ needs.post-deployment-verification.result }}" >> $GITHUB_STEP_SUMMARY

      # Optional: Send notification to Slack, Discord, etc.
      # - name: Send Slack notification
      #   if: always()
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*Deployment Verification*\n*Environment:* ${{ inputs.environment }}\n*URL:* ${{ inputs.deployment_url }}\n*Status:* ${{ steps.status.outputs.message }}"
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
