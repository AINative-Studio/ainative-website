name: Project Automation

on:
  issues:
    types: [opened, labeled, closed, reopened]
  pull_request:
    types: [opened, labeled, closed, reopened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    name: Auto-assign issues based on area

    steps:
      - name: Auto-assign based on labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue || context.payload.pull_request;
            const labels = issue.labels.map(l => l.name);

            // Define team assignments based on area labels
            const assignments = {
              'area/frontend': [], // Add GitHub usernames
              'area/backend': [],
              'area/devops': [],
              'area/seo': [],
              'area/design': [],
              'area/testing': [],
            };

            // Find matching area and assign
            for (const [label, assignees] of Object.entries(assignments)) {
              if (labels.includes(label) && assignees.length > 0) {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: assignees
                });
                console.log(`Assigned to: ${assignees.join(', ')}`);
                break;
              }
            }

  stale-check:
    runs-on: ubuntu-latest
    name: Mark stale issues
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Mark stale issues and PRs
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: |
            This issue has been automatically marked as stale because it has had no activity for 60 days.

            **What happens next:**
            - This issue will be closed in 7 days if no further activity occurs
            - You can prevent closure by commenting with updates or additional information
            - If closed, the issue can be reopened if new information becomes available

            If this issue is still relevant, please comment to keep it open.
          stale-pr-message: |
            This pull request has been automatically marked as stale because it has had no activity for 30 days.

            Please update the PR or it will be closed in 7 days.
          close-issue-message: |
            This issue was automatically closed due to inactivity. If you believe this issue is still relevant, please reopen it with updated information.
          close-pr-message: |
            This pull request was automatically closed due to inactivity.
          days-before-stale: 60
          days-before-close: 7
          days-before-pr-stale: 30
          days-before-pr-close: 7
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          exempt-issue-labels: 'priority/p0,priority/p1,status/in-progress,status/blocked'
          exempt-pr-labels: 'priority/p0,priority/p1,status/in-progress'
          operations-per-run: 100

  needs-info-check:
    runs-on: ubuntu-latest
    name: Check for needed information
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: Check if more info needed
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body = (issue.body || '').toLowerCase();

            // Check if issue body is too short or missing key information
            const isTooShort = body.length < 100;
            const missingSteps = !body.includes('steps') && !body.includes('reproduce');
            const missingExpected = !body.includes('expected') && !body.includes('should');
            const missingActual = !body.includes('actual') && !body.includes('instead');

            const isBugReport = issue.labels.some(l => l.name === 'kind/bug');

            if (isBugReport && (isTooShort || (missingSteps && missingExpected && missingActual))) {
              // Add needs-info label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['status/needs-info']
              });

              // Post comment requesting more info
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## Additional Information Needed

Thank you for reporting this issue. To help us investigate and resolve it, we need more information.

Please provide:

### For Bug Reports:
- [ ] Steps to reproduce the issue
- [ ] Expected vs. actual behavior
- [ ] Browser and version
- [ ] Operating system
- [ ] Console errors or logs
- [ ] Screenshots if applicable

---

**Note**: This issue may be marked as stale if no additional information is provided within 14 days.

If you need help gathering this information, feel free to ask!`
              });
            }

on:
  # Run stale check daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
